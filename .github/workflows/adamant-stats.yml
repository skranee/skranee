name: Update ADAMANT contribution stats

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:
  push:
    paths:
      - "README.md"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update stats in README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const owner = 'Adamant-im';
            const repo = 'adamant-im';
            const username = 'skranee';

            const now = Date.now();
            const sinceISO = new Date(now - 183*24*60*60*1000).toISOString();
            const sinceDate = sinceISO.slice(0,10);

            // --- 1. PRs merged ---
            const mergedPRs = await github.paginate("GET /repos/{owner}/{repo}/pulls", {
              owner,
              repo,
              state: "closed",
              per_page: 100,
            }, (response) =>
              response.data.filter(pr =>
                pr.merged_at &&
                pr.user.login === username &&
                new Date(pr.merged_at) >= new Date(sinceISO)
              )
            );

            let additions = 0;
            let deletions = 0;
            for (const pr of mergedPRs) {
              const prDetails = await github.request('GET /repos/{owner}/{repo}/pulls/{pull_number}', {
                owner,
                repo,
                pull_number: pr.number
              });
              additions += prDetails.data.additions;
              deletions += prDetails.data.deletions;
            }

            // --- 2. Commits ---
            let page = 1;
            let allCommits = [];
            while (true) {
              const commits = await github.request('GET /repos/{owner}/{repo}/commits', {
                owner, repo, author: username, since: sinceISO, per_page: 100, page
              });
              if (commits.data.length === 0) break;
              allCommits = allCommits.concat(commits.data);
              page++;
            }
            const commitCount = allCommits.length;

            // --- 3. PRs ---
            const prsOpened = (await github.request('GET /search/issues', {
              q: `repo:${owner}/${repo} type:pr author:${username} created:>=${sinceDate}`
            })).data.total_count;

            const prsMerged = mergedPRs.length;

            const lines = [
              `**Last 6 months in [${owner}/${repo}](https://github.com/${owner}/${repo}):**`,
              `- ðŸ§© [Commits](https://github.com/${owner}/${repo}/commits?author=${username}): **${commitCount}**`,
              `- ðŸ”€ [PRs opened](https://github.com/${owner}/${repo}/pulls?q=is%3Apr+author%3A${username}+created%3A%3E%3D${sinceDate}): **${prsOpened}** (merged: **${prsMerged}**)`,
              `- ðŸ“ˆ Lines added: **${additions.toLocaleString()}**`,
              `- ðŸ“‰ Lines removed: **${deletions.toLocaleString()}**`;

            const start = '<!-- ADAMANT-STATS:START -->';
            const end = '<!-- ADAMANT-STATS:END -->';

            const path = 'README.md';
            let readme = fs.readFileSync(path, 'utf8');
            const newBlock = `${start}\n${lines}\n${end}`;
            readme = readme.replace(new RegExp(`${start}[\\s\\S]*?${end}`), newBlock);
            fs.writeFileSync(path, readme);

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update ADAMANT repo contribution stats"
          push_options: --force
